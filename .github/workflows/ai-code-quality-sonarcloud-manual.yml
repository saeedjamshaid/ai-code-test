name: AI Code Quality - SonarCloud (Manual)

on:
  workflow_dispatch:
  push:
    branches:
      - '**'

jobs:
  quality:
    runs-on: ubuntu-latest
    timeout-minutes: 40
    env:
      SONAR_HOST: https://sonarcloud.io
      SONAR_ORG: ${{ secrets.SONAR_ORG }}
      SONAR_PROJECT_KEY: ${{ secrets.SONAR_PROJECT_KEY }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install project & analysis dependencies
        run: |
          npm ci

      - name: TypeScript compile (build project -> dist)
        continue-on-error: true
        run: |
          set +e
          npx tsc -p tsconfig.json
          EXIT_CODE=$?

          if [ "$EXIT_CODE" -eq 0 ]; then
            COMPILED=1
          else
            COMPILED=0
          fi

          node - <<NODE
          const fs = require('fs');
          const path = 'tools/AgentScoreCard.json';
          try {
            const raw = fs.readFileSync(path, 'utf8');
            const data = JSON.parse(raw);
            data.compilable = ${COMPILED};
            fs.writeFileSync(path, JSON.stringify(data, null, 2));
            console.log('Updated AgentScoreCard.json compilable to', data.compilable);
          } catch (e) {
            console.warn('Failed to update AgentScoreCard.json compilable flag', e);
          }
          NODE

          exit $EXIT_CODE

      - name: Run Node tests and update AgentScoreCard testsPassRate
        run: |
          # Run the Node test suite and capture output, but do not fail the workflow on test failure
          node --test dist/tests/app.test.js > node-test-output.txt 2>&1 || true

          # Parse test counts from the Node test runner output and update tools/AgentScoreCard.json
          node - <<'NODE'
          const fs = require('fs');

          const OUTPUT_PATH = 'node-test-output.txt';
          const SCORECARD_PATH = 'tools/AgentScoreCard.json';

          let totalTests = 0;
          let passedTests = 0;

          try {
            const text = fs.readFileSync(OUTPUT_PATH, 'utf8');

            // Summary lines typically contain "tests N" and "pass M"
            // e.g. "ℹ tests 3" / "ℹ pass 3" or similar.
            const testsMatch = text.match(/tests\s+(\d+)/);
            const passMatch = text.match(/pass\s+(\d+)/);

            if (testsMatch) totalTests = Number(testsMatch[1]) || 0;
            if (passMatch) passedTests = Number(passMatch[1]) || 0;
          } catch (e) {
            console.warn('Failed to read or parse node-test-output.txt', e);
          }

          const passRate = totalTests > 0 ? passedTests / totalTests : 0;

          try {
            const raw = fs.readFileSync(SCORECARD_PATH, 'utf8');
            const data = JSON.parse(raw);
            data.testsPassRate = passRate;
            fs.writeFileSync(SCORECARD_PATH, JSON.stringify(data, null, 2));
            console.log(
              'Updated AgentScoreCard.json testsPassRate to',
              passRate,
              `(${passedTests}/${totalTests})`
            );
          } catch (e) {
            console.warn('Failed to update AgentScoreCard.json testsPassRate', e);
          }
          NODE

      - name: Collect files/lines info
        run: |
          node - <<'NODE'
          const fs = require('fs');
          const path = require('path');
          function walk(dir, exts, files=[]) {
            if (!fs.existsSync(dir)) return files;
            for (const entry of fs.readdirSync(dir, { withFileTypes: true })) {
              const full = path.join(dir, entry.name);
              if (entry.isDirectory()) walk(full, exts, files);
              else { for (const e of exts) if (full.endsWith(e)) { files.push(full); break; } }
            }
            return files;
          }
          const files = walk('src', ['.ts','.tsx','.js','.jsx']);
          let total = 0;
          for (const f of files) { try { total += fs.readFileSync(f,'utf8').split('\n').length; } catch(e){} }
          fs.writeFileSync('files_info.json', JSON.stringify({ files: files.length, total_lines: total }));
          console.log('files_info.json written -', files.length, 'files,', total, 'lines');
          NODE

      - name: SonarCloud Scan (official action)
        uses: sonarsource/sonarcloud-github-action@v2
        with:
          args: >
            -Dsonar.organization=${{ secrets.SONAR_ORG }}
            -Dsonar.projectKey=${{ secrets.SONAR_PROJECT_KEY }}
            -Dsonar.sources=src
            -Dsonar.inclusions=src/app.ts
            -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      - name: Fetch SonarCloud measures
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          # Metrics include: coverage, security_rating, vulnerabilities, code_smells, duplicated_lines_density,
          # complexity (cyclomatic complexity), alert_status, reliability_rating, maintainability_rating
          METRICS="coverage,security_rating,vulnerabilities,code_smells,duplicated_lines_density,complexity,alert_status,reliability_rating,sqale_index"
          curl -s -u "${SONAR_TOKEN}:" "https://sonarcloud.io/api/measures/component?component=${{ secrets.SONAR_PROJECT_KEY }}&metricKeys=${METRICS}" -o sonar_metrics.json || true
          echo "Saved sonar_metrics.json"

      - name: Run compiled scoring script
        run: |
          SCORE_JS="dist/tools/score.js"
          if [ ! -f "$SCORE_JS" ]; then
            echo "$SCORE_JS not found. Listing dist/tools:"
            ls -R dist/tools || true
            exit 1
          fi

          # Run scorer
          node $SCORE_JS

          # Expected outputs:
          # - composite_score.txt
          # - score_breakdown.json (per-category scores)

      - name: Upload score artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ai-code-quality-scores
          path: |
            composite_score.txt
            score_breakdown.json
            score_report.json
            sonar_metrics.json

      - name: Print composite + detailed breakdown
        run: |
          if [ -f norms.json ]; then
            echo "Score Card:"
            cat norms.json
          fi
          if [ -f sonar_metrics.json ]; then
            echo "sonar metrics:"
            cat sonar_metrics.json
          fi
