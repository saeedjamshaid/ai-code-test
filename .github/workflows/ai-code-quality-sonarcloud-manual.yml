name: AI Code Quality - SonarCloud (Manual)

on:
  workflow_dispatch:

jobs:
  quality:
    runs-on: ubuntu-latest
    timeout-minutes: 40
    env:
      SONAR_HOST: https://sonarcloud.io
      SONAR_ORG: ${{ secrets.SONAR_ORG }}
      SONAR_PROJECT_KEY: ${{ secrets.SONAR_PROJECT_KEY }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install project & analysis dependencies
        run: |
          npm ci
          npm install -D eslint @typescript-eslint/parser @typescript-eslint/eslint-plugin \
            typhonjs-escomplex semgrep typescript

      - name: TypeScript compile (build project -> dist)
        run: npx tsc -p tsconfig.json

      - name: Run tests (Jest) with coverage
        run: npx jest --coverage --coverageReporters=json-summary --coverageReporters=lcov || true

      - name: Run ESLint (JSON)
        run: npx eslint "src/**/*.{ts,tsx,js,jsx}" -f json -o eslint.json || true

      - name: Run Semgrep (SAST)
        run: npx semgrep --config=p/ci --json --output semgrep.json || true

      - name: Run escomplex (cyclomatic complexity)
        run: npx typhonjs-escomplex -f json -o escomplex.json "src/**/*.ts" || true

      - name: Collect files/lines info
        run: |
          node - <<'NODE'
          const fs = require('fs');
          const path = require('path');
          function walk(dir, exts, files=[]) {
            if (!fs.existsSync(dir)) return files;
            for (const entry of fs.readdirSync(dir, { withFileTypes: true })) {
              const full = path.join(dir, entry.name);
              if (entry.isDirectory()) walk(full, exts, files);
              else { for (const e of exts) if (full.endsWith(e)) { files.push(full); break; } }
            }
            return files;
          }
          const files = walk('src', ['.ts','.tsx','.js','.jsx']);
          let total = 0;
          for (const f of files) { try { total += fs.readFileSync(f,'utf8').split('\n').length; } catch(e){} }
          fs.writeFileSync('files_info.json', JSON.stringify({ files: files.length, total_lines: total }));
          console.log('files_info.json written -', files.length, 'files,', total, 'lines');
          NODE

      - name: SonarCloud Scan (official action)
        uses: sonarsource/sonarcloud-github-action@v2
        with:
          args: >
            -Dsonar.organization=${{ secrets.SONAR_ORG }}
            -Dsonar.projectKey=${{ secrets.SONAR_PROJECT_KEY }}
            -Dsonar.sources=src
            -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      - name: Fetch SonarCloud measures
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          METRICS="coverage,security_rating,vulnerabilities,code_smells,duplicated_lines_density,complexity,alert_status,reliability_rating,maintainability_rating"
          curl -s -u "${SONAR_TOKEN}:" "https://sonarcloud.io/api/measures/component?component=${{ secrets.SONAR_PROJECT_KEY }}&metricKeys=${METRICS}" -o sonar_metrics.json || true
          echo "Saved sonar_metrics.json"

      - name: Run compiled scoring script
        run: |
          SCORE_JS="dist/tools/score.js"
          if [ ! -f "$SCORE_JS" ]; then
            echo "$SCORE_JS not found. Listing dist/tools:"
            ls -R dist/tools || true
            exit 1
          fi

          # Run scorer
          node $SCORE_JS

          # Expected outputs:
          # - composite_score.txt
          # - score_breakdown.json (per-category scores)

      - name: Upload score artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ai-code-quality-scores
          path: |
            composite_score.txt
            score_breakdown.json

      - name: Print composite + detailed breakdown
        run: |
          if [ -f composite_score.txt ]; then
            echo "Composite Score: $(cat composite_score.txt)"
          fi
          if [ -f score_breakdown.json ]; then
            echo "Detailed Category Breakdown:"
            cat score_breakdown.json
          fi
